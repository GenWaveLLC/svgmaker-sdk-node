name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write
  id-token: write
  models: read

jobs:
  detect-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.detect.outputs.version }}
      should-release: ${{ steps.detect.outputs.should-release }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: Detect version change
      id: detect
      run: |
        NEW_VERSION=$(node -p "require('./package.json').version")
        # Get previous commit's package.json version
        OLD_VERSION=$(git show HEAD~1:package.json | node -p "JSON.parse(require('fs').readFileSync('/dev/stdin','utf8')).version")
        if [ "$NEW_VERSION" != "$OLD_VERSION" ]; then
          # Check npm
          if npm view "@genwave/svgmaker-sdk@$NEW_VERSION" version >/dev/null 2>&1; then
            echo "Version $NEW_VERSION already on npm, skipping"
            echo "should-release=false" >> $GITHUB_OUTPUT
          else
            echo "Version changed: $OLD_VERSION -> $NEW_VERSION"
            echo "should-release=true" >> $GITHUB_OUTPUT
            echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          fi
        else
          echo "No version change, skipping"
          echo "should-release=false" >> $GITHUB_OUTPUT
        fi

  release:
    runs-on: ubuntu-latest
    needs: detect-release
    if: needs.detect-release.outputs.should-release == 'true'
    permissions:
      contents: write
      id-token: write
      models: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Use Node.js 20.x
      uses: actions/setup-node@v6
      with:
        node-version: 20.x
        cache: 'npm'
        registry-url: 'https://registry.npmjs.org'

    - name: Update npm
      run: npm install -g npm@latest

    - name: Install dependencies
      run: npm ci

    - name: Run tests
      run: npx jest --passWithNoTests --no-coverage

    - name: Run linting
      run: npm run lint

    - name: Build package
      run: npm run build

    - name: Generate release notes from GitHub
      id: github_notes
      uses: actions/github-script@v7
      with:
        script: |
          const version = '${{ needs.detect-release.outputs.version }}';
          const tagName = `v${version}`;

          // Find previous tag
          let previousTag;
          try {
            const tags = await github.rest.repos.listTags({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 10,
            });
            // First tag that isn't the current version
            const prev = tags.data.find(t => t.name !== tagName);
            if (prev) previousTag = prev.name;
          } catch (e) {
            core.info(`No previous tags found: ${e.message}`);
          }

          // Generate release notes via GitHub API
          const params = {
            owner: context.repo.owner,
            repo: context.repo.repo,
            tag_name: tagName,
          };
          if (previousTag) params.previous_tag_name = previousTag;

          const { data } = await github.rest.repos.generateReleaseNotes(params);
          core.setOutput('notes', data.body);
          core.setOutput('prev_tag', previousTag || 'none');

    - name: Enhance release notes with AI
      id: changelog
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        VERSION="${{ needs.detect-release.outputs.version }}"
        GITHUB_NOTES="${{ steps.github_notes.outputs.notes }}"

        # Build the prompt â€” GitHub notes as input, AI rewrites
        PROMPT="You are a release notes writer for @genwave/svgmaker-sdk, a Node.js SDK.
        Rewrite the following GitHub-generated release notes into polished, user-facing release notes for v${VERSION}.

        Rules:
        - Use sections: ## What's New, ## Bug Fixes, ## Other Changes (omit empty ones)
        - Write concise descriptions a developer would want to read
        - If any changes are breaking or require user action, add a ## Migration Guide section
        - Remove contributor/new-contributor boilerplate
        - Do not wrap in code fences
        - Do not include a title/heading for the version itself

        GitHub-generated notes:
        ${GITHUB_NOTES}"

        PROMPT_JSON=$(echo "$PROMPT" | jq -Rs .)

        RESPONSE=$(curl -sS -L \
          -X POST \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer $GITHUB_TOKEN" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          -H "Content-Type: application/json" \
          https://models.github.ai/inference/chat/completions \
          -d "{
            \"model\": \"openai/gpt-4.1\",
            \"messages\": [
              {\"role\": \"user\", \"content\": $PROMPT_JSON}
            ],
            \"temperature\": 0.3
          }")

        BODY=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')

        # Fallback to GitHub's raw notes if AI fails
        if [ -z "$BODY" ]; then
          echo "AI enhancement failed, using GitHub-generated notes"
          echo "API response: $RESPONSE"
          BODY="$GITHUB_NOTES"
        fi

        {
          echo 'body<<EOF'
          echo "$BODY"
          echo 'EOF'
        } >> $GITHUB_OUTPUT

    - name: Create and push git tag
      run: |
        VERSION="${{ needs.detect-release.outputs.version }}"
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag -a "v${VERSION}" -m "Release v${VERSION}"
        git push origin "v${VERSION}"

    - name: Publish to npm
      run: npm publish --provenance
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ needs.detect-release.outputs.version }}
        name: v${{ needs.detect-release.outputs.version }}
        body: ${{ steps.changelog.outputs.body }}
        prerelease: ${{ contains(needs.detect-release.outputs.version, '-') }}
        generate_release_notes: false

    - name: Notify success
      if: success()
      run: |
        VERSION="${{ needs.detect-release.outputs.version }}"
        echo "Successfully released version $VERSION"
        echo "Package published to npm: https://www.npmjs.com/package/@genwave/svgmaker-sdk"
        echo "GitHub release created: ${{ github.server_url }}/${{ github.repository }}/releases/tag/v$VERSION"
